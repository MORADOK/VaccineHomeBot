<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2em;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .summary-card h3 {
      font-size: 2.5em;
      margin-bottom: 5px;
    }

    .summary-card p {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.2em;
      color: #667eea;
    }

    .error {
      background: #fee;
      border: 2px solid #fcc;
      padding: 20px;
      border-radius: 10px;
      color: #c00;
      margin: 20px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    tbody tr:hover {
      background: #f8f9ff;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .status-scheduled {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-cancelled {
      background: #f8d7da;
      color: #721c24;
    }

    .patient-name {
      font-weight: 600;
      color: #333;
    }

    .vaccine-type {
      color: #667eea;
      font-weight: 500;
    }

    .date {
      font-family: 'Courier New', monospace;
      color: #666;
    }

    .section-title {
      font-size: 1.5em;
      color: #667eea;
      margin: 40px 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
    }

    .patient-group {
      background: #f8f9ff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 5px solid #667eea;
    }

    .patient-group h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .dose-timeline {
      display: flex;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-radius: 8px;
    }

    .dose-number {
      background: #667eea;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
    }

    .dose-info {
      flex: 1;
    }

    .dose-date {
      font-weight: 600;
      color: #333;
    }

    .dose-status {
      font-size: 0.9em;
      color: #666;
      margin-top: 3px;
    }

    .calculation-box {
      background: #e7f3ff;
      border: 2px solid #667eea;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
    }

    .calculation-box h4 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .match-indicator {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
      margin-left: 10px;
    }

    .match-yes {
      background: #d4edda;
      color: #155724;
    }

    .match-no {
      background: #fff3cd;
      color: #856404;
    }

    .interval-info {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: transform 0.2s;
      margin: 10px 5px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    .button-group {
      text-align: center;
      margin: 20px 0;
    }

    @media print {
      body {
        background: white;
        padding: 0;
      }
      .container {
        box-shadow: none;
        padding: 20px;
      }
      button {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h1>
    <p class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô VCHome Hospital</p>

    <div class="button-group">
      <button onclick="loadReport()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    </div>

    <div id="loading" class="loading">
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div id="summary" style="display: none;">
      <div class="summary"></div>
    </div>

    <div id="report" style="display: none;"></div>
  </div>

  <script>
    // Load environment variables from prompt
    const SUPABASE_URL = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà VITE_SUPABASE_URL:', 'https://your-project.supabase.co');
    const SUPABASE_KEY = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà VITE_SUPABASE_ANON_KEY:', 'your-anon-key');

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function loadReport() {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const summaryEl = document.getElementById('summary');
      const reportEl = document.getElementById('report');

      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      summaryEl.style.display = 'none';
      reportEl.style.display = 'none';

      try {
        console.log('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

        // 1. Load vaccine schedules
        const { data: schedules, error: scheduleError } = await supabase
          .from('vaccine_schedules')
          .select('*')
          .eq('active', true);

        if (scheduleError) throw scheduleError;

        console.log('üíâ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô:', schedules.length);

        // 2. Load all appointments
        const { data: allAppointments, error: apptError } = await supabase
          .from('appointments')
          .select('*')
          .order('appointment_date', { ascending: true });

        if (apptError) throw apptError;

        const completed = allAppointments.filter(a => a.status === 'completed');
        const scheduled = allAppointments.filter(a =>
          ['scheduled', 'pending'].includes(a.status) &&
          new Date(a.appointment_date) >= new Date()
        );
        const past = allAppointments.filter(a =>
          ['scheduled', 'pending'].includes(a.status) &&
          new Date(a.appointment_date) < new Date()
        );
        const cancelled = allAppointments.filter(a => a.status === 'cancelled');

        console.log('‚úÖ ‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô:', completed.length);
        console.log('üìÖ ‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á:', scheduled.length);
        console.log('‚è∞ ‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß:', past.length);
        console.log('‚ùå ‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å:', cancelled.length);

        // Display summary
        summaryEl.querySelector('.summary').innerHTML = `
          <div class="summary-card">
            <h3>${allAppointments.length}</h3>
            <p>‡∏ô‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
          </div>
          <div class="summary-card">
            <h3>${completed.length}</h3>
            <p>‡∏â‡∏µ‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</p>
          </div>
          <div class="summary-card">
            <h3>${scheduled.length}</h3>
            <p>‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</p>
          </div>
          <div class="summary-card">
            <h3>${past.length}</h3>
            <p>‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß</p>
          </div>
          <div class="summary-card">
            <h3>${cancelled.length}</h3>
            <p>‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</p>
          </div>
        `;

        // 3. Group by patient
        const patientMap = new Map();

        for (const appt of allAppointments) {
          const patientKey = appt.patient_id_number || appt.line_user_id;
          const key = `${patientKey}-${appt.vaccine_type}`;

          if (!patientMap.has(key)) {
            patientMap.set(key, {
              patient_name: appt.patient_name,
              patient_id: patientKey,
              vaccine_type: appt.vaccine_type,
              appointments: []
            });
          }

          patientMap.get(key).appointments.push(appt);
        }

        // Sort appointments by date
        for (const patient of patientMap.values()) {
          patient.appointments.sort((a, b) =>
            new Date(a.appointment_date) - new Date(b.appointment_date)
          );
        }

        // 4. Generate report
        let reportHTML = '';

        // Scheduled appointments section
        reportHTML += '<h2 class="section-title">üìÖ ‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</h2>';
        if (scheduled.length > 0) {
          reportHTML += '<table><thead><tr>';
          reportHTML += '<th>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th><th>‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>';
          reportHTML += '</tr></thead><tbody>';

          for (const appt of scheduled) {
            const daysUntil = Math.ceil((new Date(appt.appointment_date) - new Date()) / (1000 * 60 * 60 * 24));
            reportHTML += '<tr>';
            reportHTML += `<td class="patient-name">${appt.patient_name}<br><small style="color:#666;">${appt.patient_id_number || appt.line_user_id || 'N/A'}</small></td>`;
            reportHTML += `<td class="vaccine-type">${appt.vaccine_type}</td>`;
            reportHTML += `<td class="date">${new Date(appt.appointment_date).toLocaleDateString('th-TH', {
              year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            })}<br><small style="color:#667eea;">‡∏≠‡∏µ‡∏Å ${daysUntil} ‡∏ß‡∏±‡∏ô</small></td>`;
            reportHTML += `<td><span class="status-badge status-${appt.status}">${appt.status}</span></td>`;
            reportHTML += `<td>${appt.notes || '-'}</td>`;
            reportHTML += '</tr>';
          }

          reportHTML += '</tbody></table>';
        } else {
          reportHTML += '<p style="text-align:center; padding:20px; color:#666;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</p>';
        }

        // Patient groups with calculation
        reportHTML += '<h2 class="section-title">üë• ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô)</h2>';

        for (const [key, patient] of patientMap) {
          const schedule = schedules.find(s =>
            s.vaccine_type.toLowerCase() === patient.vaccine_type.toLowerCase()
          );

          if (!schedule) continue;

          const intervals = Array.isArray(schedule.dose_intervals) ?
            schedule.dose_intervals :
            JSON.parse(schedule.dose_intervals);

          const completedDoses = patient.appointments.filter(a => a.status === 'completed');
          const firstDose = completedDoses[0];

          reportHTML += '<div class="patient-group">';
          reportHTML += `<h3>${patient.patient_name} - ${schedule.vaccine_name}</h3>`;
          reportHTML += `<p style="color:#666; margin-bottom:15px;">ID: ${patient.patient_id} ‚Ä¢ ‡∏â‡∏µ‡∏î‡πÅ‡∏•‡πâ‡∏ß ${completedDoses.length}/${schedule.total_doses} ‡πÄ‡∏Ç‡πá‡∏°</p>`;

          // Timeline
          for (let i = 0; i < patient.appointments.length; i++) {
            const appt = patient.appointments[i];
            const doseNumber = completedDoses.findIndex(d => d.id === appt.id) + 1 || '?';

            // Calculate expected date
            let expectedDate = null;
            let matchStatus = '';

            if (firstDose && doseNumber > 0) {
              let cumulativeDays = 0;
              for (let j = 0; j < doseNumber - 1; j++) {
                cumulativeDays += intervals[j] || 0;
              }

              const calcDate = new Date(firstDose.appointment_date);
              calcDate.setDate(calcDate.getDate() + cumulativeDays);
              expectedDate = calcDate.toISOString().split('T')[0];

              const actualDate = appt.appointment_date;
              const daysDiff = Math.round((new Date(actualDate) - new Date(expectedDate)) / (1000 * 60 * 60 * 24));

              if (daysDiff === 0) {
                matchStatus = '<span class="match-indicator match-yes">‚úÖ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô</span>';
              } else {
                matchStatus = `<span class="match-indicator match-no">‚ö†Ô∏è ‡∏´‡πà‡∏≤‡∏á ${daysDiff > 0 ? '+' : ''}${daysDiff} ‡∏ß‡∏±‡∏ô</span>`;
              }
            }

            reportHTML += '<div class="dose-timeline">';
            reportHTML += `<div class="dose-number">${doseNumber > 0 ? doseNumber : '?'}</div>`;
            reportHTML += '<div class="dose-info">';
            reportHTML += `<div class="dose-date">${new Date(appt.appointment_date).toLocaleDateString('th-TH', {
              year: 'numeric', month: 'long', day: 'numeric'
            })} ${matchStatus}</div>`;
            reportHTML += `<div class="dose-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="status-badge status-${appt.status}">${appt.status}</span>`;
            if (appt.notes) reportHTML += ` ‚Ä¢ ${appt.notes}`;
            reportHTML += '</div>';
            if (expectedDate && doseNumber > 0) {
              const intervalUsed = doseNumber > 1 ? intervals[doseNumber - 2] : 0;
              reportHTML += `<div class="interval-info">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô: ${new Date(expectedDate).toLocaleDateString('th-TH')} (‡∏ä‡πà‡∏ß‡∏á‡∏´‡πà‡∏≤‡∏á: ${intervalUsed} ‡∏ß‡∏±‡∏ô)</div>`;
            }
            reportHTML += '</div></div>';
          }

          // Calculate next dose
          if (completedDoses.length < schedule.total_doses && firstDose) {
            let cumulativeDays = 0;
            for (let i = 0; i < completedDoses.length; i++) {
              cumulativeDays += intervals[i] || 0;
            }

            const nextDate = new Date(firstDose.appointment_date);
            nextDate.setDate(nextDate.getDate() + cumulativeDays);
            const nextDateStr = nextDate.toISOString().split('T')[0];

            const existingScheduled = patient.appointments.find(a =>
              ['scheduled', 'pending'].includes(a.status) &&
              new Date(a.appointment_date) > new Date()
            );

            reportHTML += '<div class="calculation-box">';
            reportHTML += '<h4>üìå ‡∏ô‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å vaccine_schedules)</h4>';
            reportHTML += `<p><strong>‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏µ‡πà ${completedDoses.length + 1}:</strong> ${nextDate.toLocaleDateString('th-TH', {
              year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            })}</p>`;

            if (existingScheduled) {
              if (existingScheduled.appointment_date === nextDateStr) {
                reportHTML += '<p style="color:#155724;">‚úÖ ‡∏°‡∏µ‡∏ô‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô</p>';
              } else {
                const daysDiff = Math.round((new Date(existingScheduled.appointment_date) - nextDate) / (1000 * 60 * 60 * 24));
                reportHTML += `<p style="color:#856404;">‚ö†Ô∏è ‡∏°‡∏µ‡∏ô‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ${new Date(existingScheduled.appointment_date).toLocaleDateString('th-TH')} (‡∏´‡πà‡∏≤‡∏á ${daysDiff > 0 ? '+' : ''}${daysDiff} ‡∏ß‡∏±‡∏ô)</p>`;
              }
            } else {
              reportHTML += '<p style="color:#c00;">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>';
            }

            reportHTML += '</div>';
          } else if (completedDoses.length >= schedule.total_doses) {
            reportHTML += '<div class="calculation-box" style="border-color:#28a745; background:#d4edda;">';
            reportHTML += '<h4 style="color:#155724;">‚úÖ ‡∏â‡∏µ‡∏î‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß</h4>';
            reportHTML += '</div>';
          }

          reportHTML += '</div>';
        }

        // Show results
        reportEl.innerHTML = reportHTML;
        summaryEl.style.display = 'block';
        reportEl.style.display = 'block';
        loadingEl.style.display = 'none';

      } catch (error) {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
        errorEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
        errorEl.style.display = 'block';
        loadingEl.style.display = 'none';
      }
    }

    // Auto load on page load
    if (SUPABASE_URL && SUPABASE_KEY) {
      loadReport();
    }
  </script>
</body>
</html>
