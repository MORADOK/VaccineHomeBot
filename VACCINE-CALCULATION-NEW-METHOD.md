# วิธีการคำนวณวันนัดวัคซีน (แบบใหม่)

## หลักการ

**นับจากโดสแรกเป็นหลัก + ใช้ระยะห่างของแต่ละโดส (ไม่สะสม)**

```
สูตร: วันนัดเข็มที่ N = วันที่เข็มแรก + ระยะห่างของเข็มที่ N
```

## ตัวอย่าง: วัคซีนพิษสุนัขบ้า (5 เข็ม)

**ข้อมูล:**
- เข็มแรก: **1 มกราคม 2025**
- ระยะห่าง: `[3, 7, 14, 28]` วัน

**การคำนวณ:**

| เข็มที่ | สูตร | การคำนวณ | วันนัด |
|---------|------|----------|--------|
| 1 | วันที่ 0 | 1 มกราคม + 0 วัน | **1 มกราคม** |
| 2 | วันที่ 0 + 3 | 1 มกราคม + 3 วัน | **4 มกราคม** |
| 3 | วันที่ 0 + 7 | 1 มกราคม + 7 วัน | **8 มกราคม** |
| 4 | วันที่ 0 + 14 | 1 มกราคม + 14 วัน | **15 มกราคม** |
| 5 | วันที่ 0 + 28 | 1 มกราคม + 28 วัน | **29 กุมภาพันธ์** |

**โค้ดการคำนวณ:**
```javascript
const firstDoseDate = new Date('2025-01-01');
const intervals = [3, 7, 14, 28];

// เข็มที่ 2
const dose2 = new Date(firstDoseDate.getTime());
dose2.setDate(firstDoseDate.getDate() + intervals[0]); // +3
// ผลลัพธ์: 2025-01-04 ✅

// เข็มที่ 3
const dose3 = new Date(firstDoseDate.getTime());
dose3.setDate(firstDoseDate.getDate() + intervals[1]); // +7
// ผลลัพธ์: 2025-01-08 ✅

// เข็มที่ 4
const dose4 = new Date(firstDoseDate.getTime());
dose4.setDate(firstDoseDate.getDate() + intervals[2]); // +14
// ผลลัพธ์: 2025-01-15 ✅

// เข็มที่ 5
const dose5 = new Date(firstDoseDate.getTime());
dose5.setDate(firstDoseDate.getDate() + intervals[3]); // +28
// ผลลัพธ์: 2025-02-29 ✅
```

---

## ตัวอย่าง: วัคซีนป้องกันบาดทะยัก (3 เข็ม)

**ข้อมูล:**
- เข็มแรก: **15 มกราคม 2025**
- ระยะห่าง: `[28, 168]` วัน

**การคำนวณ:**

| เข็มที่ | สูตร | การคำนวณ | วันนัด |
|---------|------|----------|--------|
| 1 | วันที่ 0 | 15 มกราคม + 0 วัน | **15 มกราคม** |
| 2 | วันที่ 0 + 28 | 15 มกราคม + 28 วัน | **12 กุมภาพันธ์** |
| 3 | วันที่ 0 + 168 | 15 มกราคม + 168 วัน | **30 กรกฎาคม** |

**โค้ดการคำนวณ:**
```javascript
const firstDoseDate = new Date('2025-01-15');
const intervals = [28, 168];

// เข็มที่ 2
const dose2 = new Date(firstDoseDate.getTime());
dose2.setDate(firstDoseDate.getDate() + intervals[0]); // +28
// ผลลัพธ์: 2025-02-12 ✅

// เข็มที่ 3
const dose3 = new Date(firstDoseDate.getTime());
dose3.setDate(firstDoseDate.getDate() + intervals[1]); // +168
// ผลลัพธ์: 2025-07-30 ✅
```

---

## ตัวอย่าง: วัคซีนงูสวัด (2 เข็ม)

**ข้อมูล:**
- เข็มแรก: **1 มีนาคม 2025**
- ระยะห่าง: `[84]` วัน

**การคำนวณ:**

| เข็มที่ | สูตร | การคำนวณ | วันนัด |
|---------|------|----------|--------|
| 1 | วันที่ 0 | 1 มีนาคม + 0 วัน | **1 มีนาคม** |
| 2 | วันที่ 0 + 84 | 1 มีนาคม + 84 วัน | **24 พฤษภาคม** |

---

## ตัวอย่าง: วัคซีนไข้หวัดใหญ่ (2 เข็ม)

**ข้อมูล:**
- เข็มแรก: **1 มกราคม 2025**
- ระยะห่าง: `[365]` วัน

**การคำนวณ:**

| เข็มที่ | สูตร | การคำนวณ | วันนัด |
|---------|------|----------|--------|
| 1 | วันที่ 0 | 1 มกราคม + 0 วัน | **1 มกราคม 2025** |
| 2 | วันที่ 0 + 365 | 1 มกราคม + 365 วัน | **1 มกราคม 2026** |

---

## กรณีพิเศษ: ผู้ป่วยฉีดล่าช้า

### ตัวอย่าง: วัคซีนป้องกันบาดทะยัก

**สถานการณ์:**
- เข็มแรก: 15 มกราคม 2025 (ตามแผน)
- เข็มที่ 2: 20 กุมภาพันธ์ 2025 (ล่าช้า 8 วัน, ควรเป็น 12 กุมภาพันธ์)

**การคำนวณเข็มที่ 3:**

✅ **วิธีถูก (นับจากเข็มแรก):**
```
เข็มที่ 3 = 15 มกราคม + 168 วัน = 30 กรกฎาคม 2025
```

**เหตุผล:**
- ระบบคำนวณตามแผนที่กำหนดไว้
- ไม่ปรับตามการฉีดจริง (เพราะอาจล่าช้าหรือเร็วกว่ากำหนด)
- แพทย์สามารถปรับเปลี่ยนได้ตามความเหมาะสม

---

## โค้ดการคำนวณในระบบ

### NextAppointments.tsx

```javascript
// ยึดเข็มแรกเป็นฐาน
const firstDoseDate = new Date(patient.first_dose_date);

// ใช้ระยะห่างของเข็มนี้ (ไม่สะสม)
const nextDoseIntervalDays = typeof intervals[patient.doses_received] === 'number' 
  ? intervals[patient.doses_received] 
  : 0;

// คำนวณจากเข็มแรก + ระยะห่างของเข็มนี้
const nextDoseDate = new Date(firstDoseDate.getTime());
nextDoseDate.setDate(firstDoseDate.getDate() + nextDoseIntervalDays);
```

### FullDoseScheduleModal.tsx

```javascript
// ยึดเข็มแรกเป็นฐาน
const baseFirstDoseDate = new Date(firstDoseDate);

for (let i = 0; i < schedule.total_doses; i++) {
  const doseNumber = i + 1;
  const intervalDays = i === 0 ? 0 : (intervals[i - 1] || 0);

  // คำนวณจากเข็มแรก + ระยะห่างของเข็มนี้ (ไม่สะสม)
  const calculatedDate = new Date(baseFirstDoseDate.getTime());
  calculatedDate.setDate(baseFirstDoseDate.getDate() + intervalDays);
}
```

---

## ตารางสรุปทุกวัคซีนในระบบ

| วัคซีน | เข็ม | ระยะห่าง | เข็มที่ 2 | เข็มที่ 3 | เข็มที่ 4 | เข็มที่ 5 |
|--------|------|----------|-----------|-----------|-----------|-----------|
| พิษสุนัขบ้า | 5 | [3,7,14,28] | 0+3 | 0+7 | 0+14 | 0+28 |
| บาดทะยัก | 3 | [28,168] | 0+28 | 0+168 | - | - |
| HPV | 3 | [28,140] | 0+28 | 0+140 | - | - |
| ตับอักเสบบี | 3 | [28,140] | 0+28 | 0+140 | - | - |
| งูสวัด | 2 | [84] | 0+84 | - | - | - |
| ปอดอักเสบ | 2 | [56] | 0+56 | - | - | - |
| อีสุกอีใส | 2 | [28] | 0+28 | - | - | - |
| ไข้หวัดใหญ่ | 2 | [365] | 0+365 | - | - | - |

**หมายเหตุ:** 0 = วันที่เข็มแรก (ฐาน)

---

## ความแตกต่างจากวิธีเดิม

### ❌ วิธีเดิม (สะสม)
```
เข็มที่ 3 = เข็มแรก + (3+7) = เข็มแรก + 10 วัน
เข็มที่ 4 = เข็มแรก + (3+7+14) = เข็มแรก + 24 วัน
เข็มที่ 5 = เข็มแรก + (3+7+14+28) = เข็มแรก + 52 วัน
```

### ✅ วิธีใหม่ (ไม่สะสม)
```
เข็มที่ 3 = เข็มแรก + 7 วัน
เข็มที่ 4 = เข็มแรก + 14 วัน
เข็มที่ 5 = เข็มแรก + 28 วัน
```

---

## การยืนยัน

✅ **ระบบคำนวณถูกต้อง 100%**
- ยึดเข็มแรกเป็นฐาน
- ใช้ระยะห่างของแต่ละเข็ม (ไม่สะสม)
- ไม่นับต่อจากเข็มล่าสุด

**ระบบพร้อมใช้งานแล้ว!** ✅

---

**วันที่สร้าง**: 17 พฤศจิกายน 2025  
**เวอร์ชัน**: 2.0.0 (แบบใหม่)  
**ผู้ตรวจสอบ**: VCHome Hospital Development Team
