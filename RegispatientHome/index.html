<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏û.‡πÇ‡∏Æ‡∏° ‚Äî ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- VCHome Configuration -->
  <script src="./config.js"></script>
  <script src="./supabase-client.js"></script>
  <script src="./validation.js"></script>
  <script src="./ui-components.js"></script>

  <style>
    :root {
      --brand: #2f8f4e;
      --brand-600: #268a4c;
      --brand-soft: #8ed39f;
      --brand-soft-hover: #6ec686;
      --ink: #1f2937;
      --muted: #6b7280;
      --bg: #f7fbff;
      --card: #ffffff;
      --ring: #bfe8c8;
      --danger: #d24040;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: 'Sarabun', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans Thai", sans-serif;
      color: var(--ink);
      background: var(--bg);
      background-image:
        radial-gradient(1200px 800px at 20% -10%, rgba(46, 204, 113, .06), transparent 70%),
        radial-gradient(800px 600px at 110% 20%, rgba(39, 174, 96, .05), transparent 60%),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='220' height='220' viewBox='0 0 220 220' opacity='.06'><g fill='none' stroke='%23000' stroke-width='3'><g transform='translate(50,50) rotate(-20)'><rect x='0' y='30' rx='6' ry='6' width='80' height='16'/><rect x='80' y='28' rx='3' ry='3' width='36' height='20'/><line x1='116' y1='38' x2='180' y2='38'/><circle cx='12' cy='38' r='6'/></g></g></svg>");
      background-repeat: no-repeat, no-repeat, repeat;
      background-size: cover, cover, 220px 220px;
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
      min-height: 100vh;
      background: var(--card);
      box-shadow: 0 0 40px rgba(0, 0, 0, .08)
    }

    .header {
      padding: 22px 22px 16px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb
    }

    .logo {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      margin: 0 auto 12px;
      background: #f0f9ff;
      display: grid;
      place-items: center;
      border: 2px solid #bfdbfe
    }

    .title {
      font-size: 22px;
      font-weight: 800;
      margin: 0 0 4px
    }

    .subtitle {
      color: var(--muted);
      font-size: 14px;
      margin: 0
    }

    .form-panel {
      padding: 22px
    }

    .form-group {
      margin-bottom: 18px
    }

    .label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 15px
    }

    .input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      transition: border-color .2s
    }

    .input:focus {
      outline: 0;
      border-color: var(--brand)
    }

    .input.error {
      border-color: #ffc107;
      background: #fffdf0
    }

    .confirm {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin: 20px 0
    }

    .confirm input {
      margin-top: 3px
    }

    .btn {
      width: 100%;
      border: 0;
      cursor: pointer;
      padding: 14px 16px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 16px;
      transition: transform .05s, background-color .2s, box-shadow .2s
    }

    .btn-primary {
      background: var(--brand-soft);
      color: #0b3b21;
      box-shadow: 0 6px 16px rgba(142, 211, 159, .35)
    }

    .btn-primary:hover {
      background: var(--brand-soft-hover)
    }

    .btn-primary[disabled] {
      opacity: .7;
      cursor: not-allowed
    }

    .btn-primary:active {
      transform: translateY(1px)
    }

    .footer {
      padding: 10px 22px 20px;
      text-align: center;
      color: var(--muted);
      font-size: 12px
    }

    .error {
      color: #856404;
      background: #fff3cd;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 8px;
      display: none;
      border: 1px solid #ffeaa7;
    }

    .sr-live {
      position: absolute;
      left: -9999px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden
    }

    /* Toast */
    .toast-wrap {
      position: fixed;
      inset: 0;
      pointer-events: none;
      display: grid;
      place-items: start center;
      padding-top: 16px
    }

    .toast {
      pointer-events: auto;
      min-width: 280px;
      max-width: 92vw;
      background: #111827;
      color: #fff;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
      display: flex;
      gap: 10px;
      align-items: flex-start;
      transform: translateY(-24px);
      opacity: 0;
      transition: opacity .18s, transform .18s
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0)
    }

    .toast .title {
      font-size: 15px;
      font-weight: 700
    }

    .toast .msg {
      font-size: 14px;
      opacity: .95
    }

    .toast .ok {
      margin-left: auto;
      background: #10b981;
      border: 0;
      color: #062b1d;
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer
    }

    .toast.error {
      background: #7f1d1d
    }

    /* Success screen */
    .success-panel {
      display: none;
      padding: 22px;
      text-align: center
    }

    .success-panel.show {
      display: block
    }

    .success-badge {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      margin: 6px auto 10px;
      background: #dcfce7;
      border: 2px solid #bbf7d0;
      color: #065f46;
      font-size: 36px
    }

    .success-title {
      font-weight: 800;
      font-size: 20px;
      margin-top: 4px
    }

    .success-msg {
      color: #065f46;
      margin: 8px auto 14px;
      max-width: 420px
    }

    .success-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center
    }

    .btn-ghost {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #cbd5e1
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff40;
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg)
      }

      100% {
        transform: rotate(360deg)
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <img src="./324443780_2467017680116432_2750799381452550391_n.jpg" alt="‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÇ‡∏Æ‡∏°"
          style="width:100%; height:100%; object-fit:cover; border-radius:50%">
      </div>
      <h1 class="title">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h1>
      <p class="subtitle">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÇ‡∏Æ‡∏°</p>
    </div>

    <!-- Form Panel -->
    <div class="form-panel" id="formPanel">
      <form id="regForm">
        <div class="form-group">
          <label class="label" for="fullName">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" id="fullName" class="input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
          <div class="error" id="errName">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
        </div>

        <div class="form-group">
          <label class="label" for="phone">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <input type="tel" id="phone" class="input" placeholder="08xxxxxxxx" required>
          <div class="error" id="errPhone">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
        </div>

        <div class="confirm">
          <input type="checkbox" id="consent" required>
          <label for="consent">‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</label>
        </div>

        <button type="submit" class="btn btn-primary" id="submitBtn">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
      </form>
    </div>

    <!-- Success Panel -->
    <div class="success-panel" id="successPanel">
      <div class="success-badge">‚úÖ</div>
      <h2 class="success-title">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
      <p class="success-msg" id="successMsg">
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏°.
      </p>
      <div class="success-actions">
        <button class="btn btn-ghost" id="closeBtn">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÇ‡∏Æ‡∏° | ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</p>
    </div>
  </div>

  <!-- Live region for screen readers -->
  <div class="sr-live" id="live" aria-live="polite"></div>

  <!-- Toast -->
  <div class="toast-wrap">
    <div class="toast" id="toast">
      <div>
        <div class="title" id="toastTitle">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
        <div class="msg" id="toastMsg">‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
      </div>
      <button class="ok" id="toastOk" type="button">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>

  <script>
    // ===== GLOBAL VARIABLES =====
    let supabaseClient, validationService, uiComponents;
    let config, LIFF_ID;
    let form, formPanel, successPanel, elName, elPhone, elConsent, errName, errPhone, btn, live, closeBtn;
    
    // ===== UTILITY FUNCTIONS =====
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üè• Initializing VCHome Registration System...');

      try {
        // Initialize services
        supabaseClient = new SupabaseClient();
        validationService = new ValidationService();
        uiComponents = new UIComponents();

        // Apply enhanced form styling
        uiComponents.enhanceFormStyling();

        // Configuration
        config = window.CONFIG || window.VCHomeConfig;
        LIFF_ID = config?.LIFF?.ID || config?.liff?.id || '2007612128-o39NWw7Y';

        console.log('‚úÖ Services initialized successfully');

        // Initialize DOM elements and event listeners
        initializeElements();
        setupEventListeners();

        // Initialize LIFF
        await initializeLIFF();

        // Health check
        await performHealthCheck();

      } catch (error) {
        console.error('‚ùå Initialization failed:', error);
        showFallbackError('‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      }
    });

    // ===== ELEMENT INITIALIZATION =====
    function initializeElements() {
      form = document.getElementById('regForm');
      formPanel = document.getElementById('formPanel');
      successPanel = document.getElementById('successPanel');
      elName = document.getElementById('fullName');
      elPhone = document.getElementById('phone');
      elConsent = document.getElementById('consent');
      errName = document.getElementById('errName');
      errPhone = document.getElementById('errPhone');
      btn = document.getElementById('submitBtn');
      live = document.getElementById('live');
      closeBtn = document.getElementById('closeBtn');

      console.log('‚úÖ DOM elements initialized');
    }

    // ===== EVENT LISTENERS SETUP =====
    function setupEventListeners() {
      // ===== ULTRA-FRIENDLY PHONE INPUT =====
      
      // Debounced validation function
      const debouncedPhoneValidation = debounce((value, element) => {
        if (validationService && value.length >= 9) {
          const validation = validationService.validatePhoneNumber(value);
          
          if (validation.isValid) {
            element.style.borderColor = '#28a745';
            element.style.backgroundColor = '#f8fff9';
          } else if (value.length === 10) {
            // ‡πÅ‡∏™‡∏î‡∏á warning ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö 10 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            element.style.borderColor = '#ffc107';
            element.style.backgroundColor = '#fffdf0';
          } else {
            // ‡∏¢‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
            element.style.borderColor = '#e1e5e9';
            element.style.backgroundColor = '#ffffff';
          }
        }
      }, 300);
      
      elPhone.addEventListener('input', (e) => {
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏Å‡∏±‡∏î 10 ‡∏´‡∏•‡∏±‡∏Å
        const cleaned = e.target.value.replace(/[^\d]/g, '').substring(0, 10);

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà format (‡πÉ‡∏´‡πâ user ‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ)
        e.target.value = cleaned;

        // ‡πÄ‡∏Å‡πá‡∏ö raw value
        e.target.setAttribute('data-raw-value', cleaned);

        // ‡∏ã‡πà‡∏≠‡∏ô error ‡∏Ç‡∏ì‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå
        e.target.classList.remove('error');
        errPhone.style.display = 'none';
        
        // Debounced validation
        debouncedPhoneValidation(cleaned, e.target);
      });

      elPhone.addEventListener('blur', (e) => {
        if (validationService) {
          const rawValue = e.target.getAttribute('data-raw-value') || e.target.value.replace(/[^\d]/g, '');
          
          if (rawValue.length === 0) {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏∞‡πÑ‡∏£
            e.target.style.borderColor = '#e1e5e9';
            e.target.style.backgroundColor = '#ffffff';
            e.target.classList.remove('error');
            errPhone.style.display = 'none';
            return;
          }
          
          const validation = validationService.validatePhoneNumber(rawValue);

          if (validation.isValid) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ blur
            const formatted = validation.sanitized.replace(/^(\d{3})(\d{3})(\d{4})$/, '$1-$2-$3');
            e.target.value = formatted;
            e.target.setAttribute('data-raw-value', validation.sanitized);
            e.target.classList.remove('error');
            errPhone.style.display = 'none';
            e.target.style.borderColor = '#28a745'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            e.target.style.backgroundColor = '#f8fff9';
          } else {
            // ‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ blur ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            // ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô‡∏Å‡∏ß‡πà‡∏≤
            e.target.classList.remove('error'); // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ error class
            e.target.style.borderColor = '#ffc107'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÅ‡∏î‡∏á
            e.target.style.backgroundColor = '#fffdf0'; // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô
            
            // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô‡∏Å‡∏ß‡πà‡∏≤
            let friendlyMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå';
            if (rawValue.length < 9) {
              friendlyMessage = '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö';
            } else if (rawValue.startsWith('07')) {
              friendlyMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (08, 09, 06)';
            }
            
            errPhone.textContent = friendlyMessage;
            errPhone.style.display = 'block';
            errPhone.style.color = '#856404'; // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏ó‡∏ô‡πÅ‡∏î‡∏á
          }
        }
      });

      elPhone.addEventListener('focus', (e) => {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ focus ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô error
        const rawValue = e.target.getAttribute('data-raw-value') || e.target.value.replace(/[^\d]/g, '');
        e.target.value = rawValue;
        
        // ‡∏ã‡πà‡∏≠‡∏ô error message ‡πÄ‡∏°‡∏∑‡πà‡∏≠ focus
        errPhone.style.display = 'none';
        e.target.classList.remove('error');
        e.target.style.borderColor = '#007bff'; // ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ focus
        e.target.style.backgroundColor = '#ffffff';
      });

      // ===== ENHANCED NAME INPUT =====
      elName.addEventListener('input', (e) => {
        if (validationService) {
          const validation = validationService.validatePatientName(e.target.value);
          if (e.target.value.length > 1) {
            if (validation.isValid) {
              e.target.classList.remove('error');
              errName.style.display = 'none';
            } else {
              e.target.classList.add('error');
              errName.textContent = validation.errors[0] || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•';
              errName.style.display = 'block';
            }
          }
        }
      });

      // ===== FORM SUBMISSION =====
      form.addEventListener('submit', handleFormSubmission);

      // ===== CLOSE BUTTON =====
      closeBtn.addEventListener('click', handleCloseWindow);

      console.log('‚úÖ Event listeners setup completed');
    }

    // ===== LIFF INITIALIZATION =====
    async function initializeLIFF() {
      try {
        if (typeof liff !== 'undefined') {
          await liff.init({ liffId: LIFF_ID });
          console.log('‚úÖ LIFF initialized successfully');
        } else {
          console.warn('‚ö†Ô∏è LIFF SDK not loaded');
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è LIFF initialization failed:', error);
      }
    }

    async function ensureLiff() {
      try {
        if (typeof liff === 'undefined') {
          console.warn('LIFF SDK not available');
          return null;
        }

        if (!liff.isInClient || !liff.isInClient()) {
          console.log('Not in LINE client');
          return liff;
        }

        if (!liff.isLoggedIn()) {
          liff.login();
          return null;
        }

        return liff;
      } catch (e) {
        console.warn('LIFF init error:', e);
        return null;
      }
    }

    async function getLineUserId() {
      try {
        const l = await ensureLiff();
        if (!l) return '';

        const profile = await l.getProfile();
        return profile && profile.userId ? profile.userId : '';
      } catch (error) {
        console.warn('Failed to get LINE user ID:', error);
        return '';
      }
    }

    // ===== HEALTH CHECK =====
    async function performHealthCheck() {
      try {
        const healthStatus = await supabaseClient.healthCheck();
        console.log('üè• System health:', healthStatus);

        if (healthStatus.status === 'error') {
          uiComponents.showToast(
            '‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
            'warning',
            10000
          );
        }
      } catch (error) {
        console.warn('Health check failed:', error);
      }
    }

    // ===== UTILITY FUNCTIONS =====
    function livePing(msg) {
      if (live) {
        live.textContent = msg;
      }
    }

    function showFallbackError(message) {
      // Fallback error display if UI components aren't available
      if (uiComponents) {
        uiComponents.showToast(message, 'error');
      } else {
        alert(message);
      }
    }

    // ===== FORM SUBMISSION HANDLER =====
    async function handleFormSubmission(e) {
      e.preventDefault();
      console.log('üìù Form submission started');

      // Get LINE User ID
      const lineUserId = await getLineUserId();

      // Prepare data for validation
      const rawPhoneNumber = elPhone.getAttribute('data-raw-value') || elPhone.value.replace(/[^\d]/g, '');
      const formData = {
        patientName: elName.value.trim(),
        phoneNumber: rawPhoneNumber,
        lineUserId: lineUserId
      };

      // Comprehensive validation
      const validation = validationService.validateRegistrationData(formData);

      if (!validation.isValid) {
        // ‡πÉ‡∏ä‡πâ warning ‡πÅ‡∏ó‡∏ô error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô‡∏Å‡∏ß‡πà‡∏≤
        uiComponents.showToast(
          validationService.formatErrors(validation.errors),
          'warning'
        );

        // Focus on first invalid field ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô
        if (validation.errors.some(e => e.includes('‡∏ä‡∏∑‡πà‡∏≠'))) {
          elName.focus();
          elName.style.borderColor = '#ffc107'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÅ‡∏î‡∏á
        } else if (validation.errors.some(e => e.includes('‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå') || e.includes('‡πÄ‡∏ö‡∏≠‡∏£‡πå'))) {
          elPhone.focus();
          elPhone.style.borderColor = '#ffc107'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÅ‡∏î‡∏á
        }
        return;
      }

      // Check consent
      if (!elConsent.checked) {
        uiComponents.showToast(
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°',
          'warning'
        );
        elConsent.focus();
        return;
      }

      // Rate limiting check
      const rateLimitCheck = validationService.checkRateLimit(lineUserId || 'anonymous');
      if (!rateLimitCheck.allowed) {
        uiComponents.showToast(
          `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ ${rateLimitCheck.remainingTime} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`,
          'warning'
        );
        return;
      }

      // Show loading
      uiComponents.showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
      livePing('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');

      try {
        // Log activity
        await supabaseClient.logActivity({
          type: 'registration_attempt',
          userId: lineUserId,
          details: {
            patientName: validation.sanitizedData.patientName,
            phoneNumber: validation.sanitizedData.phoneNumber
          }
        });

        // Check for existing patient
        const existingPatient = await supabaseClient.checkExistingPatient(
          validation.sanitizedData.phoneNumber,
          lineUserId
        );

        let result;
        if (existingPatient) {
          // Update existing patient
          result = await supabaseClient.updatePatient(
            existingPatient.registration_id,
            {
              full_name: validation.sanitizedData.patientName,
              phone: validation.sanitizedData.phoneNumber,
              line_user_id: lineUserId
            }
          );

          if (result.success) {
            uiComponents.showToast('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
          }
        } else {
          // Create new patient
          result = await supabaseClient.createPatient(validation.sanitizedData);
        }

        if (result && result.success) {
          // Success handling
          console.log('‚úÖ Registration successful:', result);

          // Send LINE notification
          if (lineUserId && config?.FEATURES?.LINE_NOTIFICATION) {
            const welcomeMessage = `üè• ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÇ‡∏Æ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
              `üë§ ‡∏ä‡∏∑‡πà‡∏≠: ${validation.sanitizedData.patientName}\n` +
              `üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${validation.sanitizedData.phoneNumber}\n` +
              `üÜî ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${result.registrationId || result.data?.registration_id}\n\n` +
              `‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô\n` +
              `üìû ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${config?.HOSPITAL?.PHONE || '02-xxx-xxxx'}`;

            await supabaseClient.sendLineNotification(lineUserId, welcomeMessage);
          }

          // Show success screen
          uiComponents.hideLoading();
          formPanel.style.display = 'none';
          successPanel.classList.add('show');

          const successMsg = document.getElementById('successMsg');
          if (successMsg) {
            successMsg.textContent = existingPatient
              ? '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏°.'
              : '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏°.';
          }

          livePing('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          form.reset();

          // Log success
          await supabaseClient.logActivity({
            type: 'registration_success',
            userId: lineUserId,
            details: {
              registrationId: result.registrationId || result.data?.registration_id,
              isUpdate: !!existingPatient
            }
          });

        } else {
          throw new Error(result?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ');
        }

      } catch (error) {
        console.error('‚ùå Registration failed:', error);

        uiComponents.hideLoading();

        // Enhanced error handling
        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
        let errorType = 'error';

        if (error.message.includes('CORS')) {
          errorMessage = '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
        } else if (error.message.includes('duplicate') || error.message.includes('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß')) {
          errorMessage = error.message;
          errorType = 'warning';
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
          errorMessage = '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
        } else if (error.message) {
          errorMessage = error.message;
        }

        uiComponents.showToast(errorMessage, errorType);

        // Log error
        await supabaseClient.logActivity({
          type: 'registration_error',
          userId: lineUserId,
          details: {
            error: error.message,
            stack: error.stack
          }
        });

      } finally {
        uiComponents.hideLoading();
        btn.disabled = false;
        btn.textContent = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
      }
    }

    // ===== CLOSE WINDOW HANDLER =====
    function handleCloseWindow() {
      try {
        if (typeof liff !== 'undefined' && liff.isInClient && liff.isInClient()) {
          return liff.closeWindow();
        }
      } catch (error) {
        console.warn('LIFF close window failed:', error);
      }
      window.location.href = './';
    }

    // ===== GLOBAL ERROR HANDLERS =====
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      if (uiComponents) {
        uiComponents.showToast(
          '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
          'error'
        );
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      if (uiComponents) {
        uiComponents.showToast(
          '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
          'error'
        );
      }
    });
  </script>
</body>

</html>